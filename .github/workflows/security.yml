name: Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # 毎日午前2時（UTC）に実行
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust stable
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-security-${{ hashFiles('**/Cargo.lock') }}

    - name: Install cargo-audit
      run: cargo install cargo-audit

    - name: Run cargo-audit
      run: cargo audit --deny warnings

    - name: Install cargo-deny
      run: cargo install cargo-deny

    - name: Run cargo-deny
      run: cargo deny check

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate

  vulnerability-scan:
    name: Vulnerability Scanning
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust stable
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-vuln-${{ hashFiles('**/Cargo.lock') }}

    - name: Run security tests
      run: cargo test --test security_tests --verbose

    - name: Check for unsafe code
      run: |
        # unsafeコードブロックの検出
        if grep -r "unsafe" src/ --include="*.rs" | grep -v "// SAFETY:"; then
          echo "警告: ドキュメント化されていないunsafeコードが検出されました"
          exit 1
        fi

  secrets-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install gitleaks
      run: |
        wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
        tar xzf gitleaks_8.18.0_linux_x64.tar.gz
        chmod +x gitleaks

    - name: Run gitleaks
      run: ./gitleaks detect --source . --verbose

  clippy-security:
    name: Clippy Security Lints
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust stable with clippy
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true
        components: clippy

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}

    - name: Run clippy with security lints
      run: |
        cargo clippy --all-targets --all-features -- \
          -D warnings

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cargo-license
      run: cargo install cargo-license

    - name: Check licenses
      run: |
        cargo license --json > licenses.json
        # MIT/Apache-2.0/BSD/ISC/Zlib/Unlicense を許可
        if grep -v -E "(MIT|Apache-2.0|BSD|ISC|Zlib|Unlicense)" licenses.json | grep -q '"license"' | grep -v -E '(Apache-2.0 OR MIT|MIT OR Apache-2.0)'; then
          echo "警告: 互換性のないライセンスが検出されました"
          cat licenses.json
          exit 1
        fi

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [security-audit, vulnerability-scan, clippy-security]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate security summary
      run: |
        echo "# セキュリティ監査レポート" > security-report.md
        echo "" >> security-report.md
        echo "**実行日時**: $(date -u)" >> security-report.md
        echo "**ブランチ**: ${{ github.ref }}" >> security-report.md
        echo "**コミット**: ${{ github.sha }}" >> security-report.md
        echo "" >> security-report.md
        echo "## 監査結果" >> security-report.md
        echo "- cargo-audit: ${{ needs.security-audit.result }}" >> security-report.md
        echo "- Vulnerability Scan: ${{ needs.vulnerability-scan.result }}" >> security-report.md
        echo "- Clippy Security: ${{ needs.clippy-security.result }}" >> security-report.md

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md
        retention-days: 30
