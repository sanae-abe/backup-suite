name: Claudeç’°å¢ƒæœˆæ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

on:
  schedule:
    # æ¯Žæœˆ1æ—¥ 10:00 (UTC) ã«å®Ÿè¡Œ = JST 19:00
    - cron: '0 10 1 * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  monthly-maintenance:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Claude environment
        run: |
          mkdir -p ~/.claude/{scripts,logs,reports,backups,docs}

          # .claudeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚³ãƒ”ãƒ¼
          if [ -d ".claude" ]; then
            cp -r .claude/* ~/.claude/ || true
          fi

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq ripgrep fd-find

      - name: Verify script exists
        run: |
          if [ ! -f ~/.claude/scripts/monthly-maintenance.sh ]; then
            echo "Error: monthly-maintenance.sh not found"
            exit 1
          fi
          chmod +x ~/.claude/scripts/*.sh

      - name: Run monthly maintenance
        id: maintenance
        run: |
          cd ~/.claude/scripts
          ./monthly-maintenance.sh --quiet --no-cleanup
        continue-on-error: true

      - name: Check maintenance result
        id: check_result
        run: |
          if [ ${{ steps.maintenance.outcome }} == 'success' ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Upload maintenance report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: monthly-maintenance-report-${{ github.run_number }}
          path: ~/.claude/reports/monthly-*.md
          retention-days: 90
          if-no-files-found: warn

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: monthly-maintenance-logs-${{ github.run_number }}
          path: ~/.claude/logs/monthly-*.log
          retention-days: 30
          if-no-files-found: warn

      - name: Generate summary
        if: always()
        run: |
          echo "## Claudeç’°å¢ƒæœˆæ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ steps.check_result.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ãƒ¬ãƒãƒ¼ãƒˆå­˜åœ¨ç¢ºèª
          if [ -f ~/.claude/reports/monthly-*.md ]; then
            REPORT_FILE=$(ls -t ~/.claude/reports/monthly-*.md | head -1)
            echo "### ðŸ“Š ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -50 "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: failure() && steps.maintenance.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            const body = `## Claudeç’°å¢ƒæœˆæ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å¤±æ•— ðŸš¨

**å®Ÿè¡Œæ—¥æ™‚**: ${date}
**å®Ÿè¡ŒID**: ${{ github.run_id }}
**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª](${runUrl})

### æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **ãƒ­ã‚°ç¢ºèª**: Artifactsã‹ã‚‰ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è©³ç´°ç¢ºèª
2. **ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ**: \`~/.claude/scripts/monthly-maintenance.sh\` ã‚’æ‰‹å‹•å®Ÿè¡Œ
3. **å•é¡Œä¿®æ­£**: æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã‚’ä¿®æ­£
4. **å†å®Ÿè¡Œ**: GitHub Actionsã§æ‰‹å‹•å†å®Ÿè¡Œ

### ãƒã‚§ãƒƒã‚¯é …ç›®

- [ ] ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
- [ ] è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ï¼ˆvalidate-all.shï¼‰
- [ ] ä¾å­˜é–¢ä¿‚ç¢ºèª
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»çµæžœç¢ºèª

---

**è‡ªå‹•ç”Ÿæˆ**: Claudeæœˆæ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[è‡ªå‹•] Claudeæœˆæ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å¤±æ•— (${date})`,
              body: body,
              labels: ['maintenance', 'alert', 'automated']
            });

      - name: Comment on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            console.log(`âœ… Claudeæœˆæ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æˆåŠŸ: ${date}`);

  # ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆå››åŠæœŸã”ã¨ï¼‰
  security-audit:
    runs-on: ubuntu-latest
    # 1æœˆã€4æœˆã€7æœˆã€10æœˆã®1æ—¥ã«å®Ÿè¡Œ
    if: github.event.schedule == '0 10 1 * *' && (github.event.repository.pushed_at == null || contains(fromJSON('["01", "04", "07", "10"]'), format('{0:MM}', github.event.repository.pushed_at)))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Security audit notification
        run: |
          echo "ðŸ”’ å››åŠæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã®æ™‚æœŸã§ã™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä»¥ä¸‹ã®ç›£æŸ»ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„:" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ç›£æŸ»" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒ¬ãƒ“ãƒ¥ãƒ¼" >> $GITHUB_STEP_SUMMARY
