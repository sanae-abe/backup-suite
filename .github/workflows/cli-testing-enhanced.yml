name: Enhanced CLI Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  bats-tests-with-ai-analysis:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build backup-suite
      run: |
        cargo build --release --all-features
        cp target/release/backup-suite /usr/local/bin/

    - name: Install BATS
      uses: bats-core/bats-action@2.0.0

    - name: Setup test environment
      run: |
        mkdir -p reports
        chmod +x tests/bats/*.bats

    - name: Run BATS Tests
      id: bats
      continue-on-error: true
      run: |
        cd tests/bats
        bats *.bats --formatter junit > ../../reports/bats-junit.xml || true
        bats *.bats --formatter tap > ../../reports/bats-tap.txt || true

        # Count pass/fail
        TOTAL=$(grep -c "testcase" ../../reports/bats-junit.xml || echo "0")
        FAILURES=$(grep -c 'failure' ../../reports/bats-junit.xml || echo "0")
        PASSED=$((TOTAL - FAILURES))

        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILURES" >> $GITHUB_OUTPUT

        # Fail job if tests failed
        if [ "$FAILURES" -gt 0 ]; then
          exit 1
        fi

    - name: Generate Test Summary
      if: always()
      run: |
        echo "## BATS CLI Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Total Tests: ${{ steps.bats.outputs.total }}" >> $GITHUB_STEP_SUMMARY
        echo "- Passed: ${{ steps.bats.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
        echo "- Failed: ${{ steps.bats.outputs.failed }}" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.bats.outputs.failed }}" -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -A 5 'failure' reports/bats-junit.xml | head -50 >> $GITHUB_STEP_SUMMARY || echo "No failure details available"
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cli-test-reports
        path: reports/
        retention-days: 30

    - name: Comment Test Results on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const total = '${{ steps.bats.outputs.total }}';
          const passed = '${{ steps.bats.outputs.passed }}';
          const failed = '${{ steps.bats.outputs.failed }}';
          const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;

          const comment = `## üß™ CLI Test Results

          - **Pass Rate**: ${passRate}% (${passed}/${total} tests)
          ${failed > 0 ? `- ‚ö†Ô∏è **Failed Tests**: ${failed}` : '- ‚úÖ All tests passed!'}

          <details>
          <summary>View detailed report</summary>

          Test artifacts uploaded to workflow run.
          Download the \`cli-test-reports\` artifact for full details.

          </details>`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
