name: Test Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust stable
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true
        components: llvm-tools-preview

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}

    - name: Install cargo-tarpaulin
      run: cargo install cargo-tarpaulin

    - name: Generate coverage
      run: |
        cargo tarpaulin \
          --verbose \
          --all-features \
          --workspace \
          --timeout 600 \
          --out Xml \
          --out Html \
          --output-dir coverage

    - name: Upload to codecov.io
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/cobertura.xml
        fail_ci_if_error: false

    - name: Upload coverage HTML
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

    - name: Check coverage threshold
      run: |
        # coverage.xmlから総カバレッジを抽出
        COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage/cobertura.xml | head -1)
        COVERAGE_PERCENT=$(echo "$COVERAGE * 100" | bc)
        echo "テストカバレッジ: ${COVERAGE_PERCENT}%"

        # 45%以上を要求（段階的な改善目標: Phase 1: 45% → Phase 2: 50% → Phase 3: 60% → Phase 4: 70% → Phase 5: 80%）
        THRESHOLD=45
        if (( $(echo "$COVERAGE_PERCENT < $THRESHOLD" | bc -l) )); then
          echo "エラー: カバレッジが閾値を下回っています: ${COVERAGE_PERCENT}% < ${THRESHOLD}%"
          exit 1
        fi

  unit-coverage:
    name: Unit Test Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust stable
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true

    - name: Run unit tests with coverage
      run: |
        cargo test --lib --verbose -- --test-threads=1
        cargo test --bins --verbose -- --test-threads=1

  integration-coverage:
    name: Integration Test Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust stable
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true

    - name: Run integration tests
      run: cargo test --test '*' --verbose -- --test-threads=1

  doc-coverage:
    name: Documentation Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust nightly
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
        profile: minimal
        override: true

    - name: Check documentation coverage
      run: |
        cargo +nightly rustdoc --lib -- -Z unstable-options --show-coverage

    - name: Generate documentation
      run: cargo doc --no-deps --all-features

    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: target/doc/
        retention-days: 30

  coverage-report:
    name: Coverage Summary
    runs-on: ubuntu-latest
    needs: [coverage, unit-coverage, integration-coverage, doc-coverage]
    if: always()

    steps:
    - name: Generate summary
      run: |
        echo "# テストカバレッジレポート" > coverage-summary.md
        echo "" >> coverage-summary.md
        echo "**実行日時**: $(date -u)" >> coverage-summary.md
        echo "**ブランチ**: ${{ github.ref }}" >> coverage-summary.md
        echo "**コミット**: ${{ github.sha }}" >> coverage-summary.md
        echo "" >> coverage-summary.md
        echo "## 結果" >> coverage-summary.md
        echo "- 総合カバレッジ: ${{ needs.coverage.result }}" >> coverage-summary.md
        echo "- 単体テスト: ${{ needs.unit-coverage.result }}" >> coverage-summary.md
        echo "- 統合テスト: ${{ needs.integration-coverage.result }}" >> coverage-summary.md
        echo "- ドキュメント: ${{ needs.doc-coverage.result }}" >> coverage-summary.md

    - name: Upload summary
      uses: actions/upload-artifact@v4
      with:
        name: coverage-summary
        path: coverage-summary.md
        retention-days: 30
