# Smart機能 - 包括的ガイド

**バージョン**: 1.0.0 (Phase 1完成)
**最終更新**: 2025-11-09

---

## 目次

1. [概要](#概要)
2. [アーキテクチャ](#アーキテクチャ)
3. [機能詳細](#機能詳細)
4. [使用例とユースケース](#使用例とユースケース)
5. [パフォーマンス](#パフォーマンス)
6. [セキュリティ](#セキュリティ)
7. [技術仕様](#技術仕様)
8. [トラブルシューティング](#トラブルシューティング)

---

## 概要

backup-suite のSmart機能は、統計的機械学習とルールベースの推論を組み合わせた**インテリジェントバックアップ管理システム**です。

### 主要な価値提案

- **異常検知**: 過去の履歴から統計的に異常なバックアップを自動検知（< 1ms）
- **ファイル重要度分析**: ディレクトリ内のファイルを重要度別に自動分類（~8秒/10,000ファイル）
- **除外パターン推奨**: 不要なファイル（キャッシュ、ビルド成果物）を自動検出・除外提案
- **自動設定**: ディレクトリを分析し、最適なバックアップ設定を自動生成

### Phase 1: 軽量ML機能（現在実装済み）

**完全にオフライン動作** - 外部APIやクラウドサービス不要、プライバシー完全保護

| 機能カテゴリ | 技術手法 | パフォーマンス |
|-------------|---------|---------------|
| 異常検知 | Z-score統計分析 | < 1ms/100件履歴 |
| ディスク容量予測 | 線形回帰 | < 5ms |
| 失敗パターン分析 | 頻度分析・時間帯別集計 | < 10ms |
| ファイル重要度評価 | ルールベーススコアリング | ~50μs/ファイル |
| 除外パターン検出 | パターンマッチング・サイズ分析 | ~5秒/10,000ファイル |

---

## アーキテクチャ

### モジュール構造

```
src/smart/
├── mod.rs                       # 公開APIエクスポート
├── types.rs                     # 型定義（Newtype Pattern）
├── error.rs                     # AI固有のエラー型
├── anomaly/                     # 異常検知エンジン
│   ├── mod.rs
│   ├── detector.rs              # 統計的異常検知（Z-score）
│   ├── predictor.rs             # ディスク容量予測（線形回帰）
│   └── pattern.rs               # 失敗パターン分析
└── recommendation/              # インテリジェント推奨
    ├── mod.rs
    ├── importance.rs            # ファイル重要度判定
    ├── suggest.rs               # バックアップ対象の自動提案
    └── exclude.rs               # 除外パターン自動検出
```

### データフロー

```
ユーザー入力（ディレクトリパス）
    ↓
┌───────────────────────────────────────┐
│ 1. ファイルシステム走査（WalkDir）      │
│    - 再帰的ディレクトリ探索             │
│    - セキュリティ検証（パストラバーサル） │
└───────────────────────────────────────┘
    ↓
┌───────────────────────────────────────┐
│ 2. 重要度評価（ImportanceEvaluator）   │
│    - 拡張子ベース分類                  │
│    - ディレクトリパターンマッチング      │
│    - キャッシング（再評価高速化）        │
└───────────────────────────────────────┘
    ↓
┌───────────────────────────────────────┐
│ 3. 推奨エンジン（Suggest/Exclude）     │
│    - 優先度別グルーピング              │
│    - 除外候補の検出                   │
│    - サイズ削減量の計算                │
└───────────────────────────────────────┘
    ↓
出力（推奨設定・除外パターン）
```

### 型安全性（Newtype Pattern）

すべてのSmart機能で強い型付けを採用し、実行時エラーを防止：

```rust
pub struct BackupSize(u64);           // バックアップサイズ（バイト）
pub struct FileImportance(u8);        // ファイル重要度（0-100）
pub struct PredictionConfidence(f64); // 予測信頼度（0.0-1.0）
pub struct DiskCapacity(u64);         // ディスク容量（バイト）
pub struct FailureRate(f64);          // 失敗率（0.0-1.0）
```

**利点**:
- コンパイル時の型チェック（`BackupSize`と`DiskCapacity`の混同を防止）
- 範囲外値の検出（`FileImportance::new(150)` → エラー）
- ゼロ除算の防止（`DiskCapacity::usage_rate()`）

---

## 機能詳細

### 1. 異常検知（Anomaly Detection）

#### 1.1 バックアップサイズ異常検知

**アルゴリズム**: Z-score統計分析

```rust
Z = (current_size - mean) / std_dev
```

- **Z > 3.0**: 異常（通常の3倍以上の標準偏差）
- **信頼度**: 95.3%以上（Z-scoreに基づく統計的信頼区間）

**CLI使用例**:
```bash
# 過去7日間の異常検知
backup-suite smart detect --days 7

# 出力例:
# 🤖 AI異常検知レポート（過去7日間）
#
# ┌────┬──────────────────┬──────────┬──────────┬─────────────────────┐
# │ No │ 検出日時          │ 異常種別  │ 信頼度    │ 説明                 │
# ├────┼──────────────────┼──────────┼──────────┼─────────────────────┤
# │ 1  │ 2025-11-09 03:15 │ サイズ急増│ 95.3%    │ ファイルサイズが通常の3倍 │
# └────┴──────────────────┴──────────┴──────────┴─────────────────────┘
#
# 📊 サマリー: 1件の異常を検出
# 💡 推奨アクション: ~/Downloads の一時ファイルを除外設定に追加
```

**詳細分析モード**:
```bash
backup-suite smart detect --days 14 --detailed

# 出力に追加される統計情報:
# - 平均バックアップサイズ: 1.23 GB
# - 標準偏差: 0.45 GB
# - 最大/最小サイズ
# - 移動平均グラフ（7日間）
```

#### 1.2 ディスク容量予測

**アルゴリズム**: 線形回帰（最小二乗法）

```rust
y = slope * x + intercept
```

- **トレンド検出**: 容量増加率の計算
- **枯渇予測**: 残り日数の推定
- **信頼度**: R²値に基づく（0.0-1.0）

**CLI使用例**:
```bash
backup-suite smart detect --days 30 --detailed

# 出力例:
# ⚠️ ディスク容量予測:
#   現在の使用率: 82%
#   予測される枯渇日: 2025-12-24（約45日後）
#   推奨対策: 古いバックアップの削除または保存先の変更
```

#### 1.3 失敗パターン分析

**アルゴリズム**: 頻度分析・時間帯別集計

- **カテゴリ別失敗率**: どのカテゴリ（work/personal等）が失敗しやすいか
- **時刻別失敗率**: どの時間帯にバックアップが失敗しやすいか
- **失敗原因の推定**: エラーパターンから推定

**CLI使用例**:
```bash
backup-suite smart detect --days 30 --detailed

# 出力例:
# 📉 失敗パターン分析:
#   全体失敗率: 2.2%（2/90回）
#
#   カテゴリ別:
#     - work: 0% (0/45)
#     - personal: 4.4% (2/45)
#
#   時刻別:
#     - 02:00-03:00: 5% (失敗2回/40回)
#     - その他の時間帯: 0%
#
#   推奨アクション: 午前2-3時のバックアップスケジュールを見直す
```

### 2. ファイル重要度分析

#### 2.1 重要度スコアリング

**ルールベース評価**: 拡張子・ディレクトリパターンに基づく0-100点のスコア

| カテゴリ | 拡張子例 | ベーススコア | 優先度 |
|---------|---------|------------|--------|
| ソースコード | .rs, .py, .js, .ts, .go | 95 | High |
| ドキュメント | .pdf, .docx, .xlsx, .pptx | 90 | High |
| 設定ファイル | .toml, .json, .yaml, .ini | 85 | High |
| データベース | .db, .sqlite, .csv | 70 | Medium |
| 画像 | .jpg, .png, .svg | 60 | Medium |
| 動画 | .mp4, .mkv, .avi | 50 | Medium |
| ログ | .log | 20 | Low |
| 一時ファイル | .tmp, .cache, .bak | 10 | Low |

**ボーナススコア**:
- バージョン番号付き（`report_v2.pdf`）: +5点
- "final"/"important"キーワード: +10点
- 最近変更（7日以内）: +5点

**CLI使用例**:
```bash
# ディレクトリの重要度分析
backup-suite smart analyze ~/Documents

# 出力例:
# 🤖 AIファイル重要度分析: ~/Documents
#
# ┌─────────────────────────────┬──────────────┬──────────┬─────────────────────┐
# │ ファイル/ディレクトリ         │ 重要度スコア   │ 提案優先度 │ 理由                 │
# ├─────────────────────────────┼──────────────┼──────────┼─────────────────────┤
# │ src/                        │ ████████ 95  │ 高        │ ソースコード（頻繁更新）│
# │ reports/                    │ ████████ 90  │ 高        │ ドキュメント（重要）  │
# │ photos/                     │ ████░░░░ 60  │ 中        │ 画像ファイル          │
# │ .cache/                     │ █░░░░░░░ 10  │ 除外推奨  │ キャッシュディレクトリ │
# └─────────────────────────────┴──────────────┴──────────┴─────────────────────┘
```

#### 2.2 詳細分析モード

```bash
backup-suite smart analyze ~/Documents --detailed

# 追加される情報:
# - ファイル数統計（カテゴリ別）
# - 総サイズ（カテゴリ別）
# - 変更頻度分析
# - 推奨バックアップスケジュール
```

#### 2.3 フィルタリング

```bash
# 特定のファイル種別のみ分析
backup-suite smart analyze ~/projects --filter "*.rs,*.toml,Cargo.lock"

# 出力例: Rustプロジェクトのソースファイルのみ分析
```

### 3. 除外パターン推奨

#### 3.1 自動検出パターン

| パターン | 理由 | 信頼度 | 削減量目安 |
|---------|------|--------|-----------|
| `node_modules/` | npm依存関係（再生成可能） | 99% | 数百MB-数GB |
| `target/` | Rustビルド成果物 | 99% | 数百MB-数GB |
| `__pycache__/` | Pythonキャッシュ | 99% | 数十MB |
| `.cache/` | キャッシュディレクトリ | 95% | 数十MB-数GB |
| `dist/`, `build/` | ビルド成果物 | 90% | 数十MB-数百MB |
| `.git/` | Gitメタデータ | 70% | 数十MB-数百MB |
| `*.tmp`, `*.temp` | 一時ファイル | 99% | 数MB-数十MB |
| `*.log` | ログファイル | 70% | 数MB-数百MB |

**セキュリティ設計**:
- **ホワイトリスト方式**: 明示的に安全なパターンのみ除外推奨
- **重要ファイル保護**: ソースコード・設定ファイルは除外推奨しない
- **サイズ閾値**: 10MB未満の除外は提案しない（誤除外防止）

**CLI使用例**:
```bash
# 除外パターンの推奨を表示
backup-suite smart suggest-exclude ~/projects

# 出力例:
# 🤖 AI除外パターン推奨: ~/projects
#
# ┌──────────────────┬──────────┬──────────┬─────────────────────┐
# │ パターン          │ 削減量    │ 信頼度    │ 理由                 │
# ├──────────────────┼──────────┼──────────┼─────────────────────┤
# │ node_modules/    │ 2.34 GB  │ 99%      │ npm依存関係（再生成可能）│
# │ target/          │ 1.87 GB  │ 99%      │ Rustビルド成果物      │
# │ .cache/          │ 0.45 GB  │ 95%      │ キャッシュディレクトリ │
# └──────────────────┴──────────┴──────────┴─────────────────────┘
#
# 💡 総削減量: 4.66 GB（バックアップ時間を約30%短縮）
```

#### 3.2 自動適用

```bash
# 推奨パターンを自動的に設定ファイルに適用
backup-suite smart suggest-exclude ~/projects --apply

# 確認メッセージ:
# ✅ 以下の除外パターンを設定ファイルに追加しました:
#    - node_modules/
#    - target/
#    - .cache/
#
# 設定ファイル: ~/.config/backup-suite/config.toml
```

#### 3.3 最小サイズ指定

```bash
# 最小ファイルサイズを指定（デフォルト: 100MB）
backup-suite smart suggest-exclude ~/projects --min-size 50MB

# 50MB以上の除外候補のみ推奨
```

### 4. AI自動設定

#### 4.1 自動分析・設定

ディレクトリを包括的に分析し、最適なバックアップ設定を自動生成：

```bash
# 自動分析・設定
backup-suite smart auto-configure ~/data

# 処理フロー:
# 1. ディレクトリ走査・ファイル分析
# 2. 重要度評価・優先度判定
# 3. 除外パターン検出
# 4. 最適な圧縮レベル推奨
# 5. バックアップスケジュール提案
# 6. 設定ファイルに自動反映
```

**出力例**:
```
🤖 AI自動設定レポート: ~/data

📊 分析結果:
  - 総ファイル数: 12,345ファイル
  - 総サイズ: 15.6 GB
  - 推奨優先度: High（重要なソースコード・ドキュメント多数）
  - 除外可能サイズ: 3.2 GB（node_modules, .cache等）

⚙️ 推奨設定:
  - バックアップ対象: ~/data
  - 優先度: high
  - スケジュール: 毎日午前2時
  - 圧縮: zstd（レベル3）
  - 暗号化: 有効化推奨
  - 除外パターン:
    * node_modules/
    * target/
    * .cache/
    * *.tmp

✅ 設定を ~/.config/backup-suite/config.toml に保存しました
```

#### 4.2 対話的設定

```bash
# 対話的に確認しながら設定
backup-suite smart auto-configure ~/data --interactive

# 各ステップで確認プロンプトを表示:
# ❓ 推奨優先度は「High」ですが、変更しますか？ [y/N]
# ❓ 除外パターン「node_modules/」を適用しますか？ [Y/n]
```

#### 4.3 ドライラン

```bash
# 設定を適用せず確認のみ
backup-suite smart auto-configure ~/data --dry-run

# 設定内容を表示するが、ファイルには書き込まない
```

---

## 使用例とユースケース

### ユースケース1: 開発プロジェクトのバックアップ最適化

**シナリオ**: Rustプロジェクト（10,000ファイル、5GB）をバックアップしたいが、`target/`や`.cache/`は除外したい

```bash
# 1. ディレクトリ分析
backup-suite smart analyze ~/projects/my-app

# 分析結果:
# - src/: 重要度95（高優先度）
# - Cargo.toml: 重要度85（高優先度）
# - target/: 重要度10（除外推奨）
# - .cache/: 重要度10（除外推奨）

# 2. 除外パターン推奨
backup-suite smart suggest-exclude ~/projects/my-app --apply

# 除外パターン追加:
# - target/（1.2GB削減）
# - .cache/（0.3GB削減）

# 3. バックアップ実行
backup-suite run --priority high --compress zstd

# 結果:
# バックアップ時間: 90%短縮（5GB → 3.5GB）
# ストレージ使用量: 70%削減（Zstd圧縮後）
```

### ユースケース2: 異常なバックアップの検知

**シナリオ**: 定期バックアップが急にサイズ3倍になり、原因を調査したい

```bash
# 1. 異常検知レポート
backup-suite smart detect --days 7 --detailed

# 検出結果:
# ⚠️ 2025-11-09 03:15 - サイズ急増（Z-score: 3.8、信頼度95%）
#    - 通常: 1.2GB
#    - 今回: 3.6GB（3倍）
#    - 原因候補: ~/Downloads に大容量ファイル（2.4GB）

# 2. 除外パターン追加
backup-suite smart suggest-exclude ~/Downloads --apply

# 3. 次回バックアップで正常化確認
backup-suite run --dry-run
```

### ユースケース3: ディスク容量枯渇の予防

**シナリオ**: バックアップ先のディスク容量が不足しそうなので、事前に対策したい

```bash
# 1. ディスク容量予測
backup-suite smart detect --days 30 --detailed

# 予測結果:
# ⚠️ ディスク容量予測:
#    現在の使用率: 82%
#    予測される枯渇日: 2025-12-24（約45日後）
#    推奨対策: 古いバックアップの削除

# 2. 古いバックアップ削除
backup-suite cleanup --days 30

# 3. 除外パターン最適化
backup-suite smart suggest-exclude ~/backups --min-size 100MB --apply

# 結果:
# - 4.5GB削減
# - 枯渇予測日が90日後に延長
```

### ユースケース4: 新規ディレクトリの自動設定

**シナリオ**: 新しいプロジェクトディレクトリを追加し、最適な設定を自動生成したい

```bash
# 1. AI自動設定（対話モード）
backup-suite smart auto-configure ~/new-project --interactive

# 対話プロンプト:
# 🤖 ディレクトリ分析中... [完了]
#
# 📊 分析結果:
#    - 重要度: High（ソースコード多数）
#    - 推奨優先度: high
#    - 推奨スケジュール: 毎日
#
# ❓ この設定を適用しますか？ [Y/n] y
# ✅ 設定を保存しました

# 2. 確認
backup-suite list

# 出力:
# ┌──────────────────┬──────────┬────────────┬─────────────┐
# │ パス              │ 優先度    │ カテゴリ    │ 除外パターン │
# ├──────────────────┼──────────┼────────────┼─────────────┤
# │ ~/new-project    │ high     │ development│ target/, .cache/ │
# └──────────────────┴──────────┴────────────┴─────────────┘
```

---

## パフォーマンス

### ベンチマーク結果

| 操作 | データ量 | 実測時間 | 目標 | 状態 |
|------|---------|---------|------|------|
| 異常検知 | 100件履歴 | < 1ms | 5ms | ✅ 500%達成 |
| ディスク容量予測 | 30日分データ | < 5ms | 5ms | ✅ 100%達成 |
| 失敗パターン分析 | 100件履歴 | < 10ms | 10ms | ✅ 100%達成 |
| ファイル重要度評価 | 1ファイル | ~50μs | 100μs | ✅ 200%達成 |
| ディレクトリ分析 | 10,000ファイル | ~8秒 | 10秒 | ✅ 125%達成 |
| 除外パターン検出 | 10,000ファイル | ~5秒 | 10秒 | ✅ 200%達成 |

### メモリ使用量

- **ファイル重要度評価**: O(1)（キャッシュなし）、O(n)（キャッシュあり）
- **ディレクトリ走査**: O(d)（dはディレクトリ数）
- **異常検知**: O(h)（hは履歴数）
- **統計計算**: O(1)（メモリ効率的なストリーミング処理）

### 並列処理

Rayon を使用した並列ファイル評価：

```rust
// 並列で重要度評価
let results: Vec<_> = entries
    .par_iter()
    .map(|entry| self.evaluate_importance(entry.path()))
    .collect();
```

**スケーラビリティ**:
- 4コアCPU: 3.5倍高速化
- 8コアCPU: 7倍高速化

---

## セキュリティ

### プライバシー保護

**完全オフライン動作** - すべてのSmart機能はローカルで実行：

- ✅ 外部APIコール: なし
- ✅ クラウドサービス: 不要
- ✅ 機密情報の送信: ゼロ
- ✅ データ収集: なし

### パストラバーサル対策

すべてのファイルアクセスで安全性検証：

```rust
use backup_suite::security::validate_path_safety;

// ../../../etc/passwd などの危険なパスを拒否
validate_path_safety(path)?;
```

### ファイルアクセス権限

- **読み取り専用操作**: Smart機能はファイル内容を変更しない
- **シンボリックリンク追跡なし**: `follow_links(false)`
- **セキュアオープン**: `safe_open()`による安全なファイルオープン

### セキュリティ監査

すべてのSmart機能モジュールは以下を遵守：

- ✅ パストラバーサル対策
- ✅ 型安全性（Newtype Pattern）
- ✅ エラーハンドリング（thiserror）
- ✅ メモリ安全性（Rustの保証）
- ✅ テストカバレッジ76%（目標95%）

---

## 技術仕様

### 依存クレート

```toml
[dependencies]
# 統計計算
statrs = "0.17"  # Z-score、線形回帰、標準偏差

# ファイルシステム
walkdir = "2.5"  # ディレクトリ走査

# 並列処理
rayon = "1.11"   # 並列ファイル評価

# エラー処理
thiserror = "1.0"  # カスタムエラー型
anyhow = "1.0"     # エラー伝播
```

### MSRV互換性

- **Rust 1.82.0+**: すべてのSmart機能で動作保証
- **statrs 0.17**: Rust 1.70+ 対応

### Feature Gate

Smart機能はオプション機能として実装：

```bash
# Smart機能を有効化してビルド
cargo build --release --features smart
cargo install --path . --features smart

# Smart機能なしでビルド（軽量バイナリ）
cargo build --release
cargo install --path .
```

**バイナリサイズ**:
- Smart機能あり: 約5.2MB（strip後）
- Smart機能なし: 約4.8MB（strip後）

---

## トラブルシューティング

### Q1. `backup-suite ai` コマンドが見つからない

**原因**: Smart機能なしでビルドされている

**解決策**:
```bash
# Smart機能を有効化して再ビルド
cargo build --release --features smart
cargo install --path . --features smart --force
```

### Q2. 異常検知で「データ不足」エラー

**エラーメッセージ**:
```
Error: データ不足: 最低7件必要ですが、3件しかありません
```

**原因**: 履歴データが少なすぎる（Z-score計算には最低7件必要）

**解決策**:
1. より多くのバックアップを実行
2. `--days` オプションを減らして範囲を狭める
3. `--detailed` オプションなしで実行（より少ないデータで動作）

### Q3. ファイル重要度分析が遅い

**症状**: `backup-suite smart analyze` が10秒以上かかる

**原因**: ファイル数が非常に多い（10,000ファイル以上）

**解決策**:
1. 特定のディレクトリのみ分析
2. `--filter` オプションでファイル種別を絞る
3. 並列度を調整（環境変数 `RAYON_NUM_THREADS`）

```bash
# 並列度を8に設定
RAYON_NUM_THREADS=8 backup-suite smart analyze ~/large-dir
```

### Q4. 除外パターンが適用されない

**症状**: `--apply` オプションを使ったが、除外パターンが反映されない

**原因**: 設定ファイルの権限またはパスの問題

**解決策**:
1. 設定ファイルの場所を確認
```bash
backup-suite config get-destination
```

2. 手動で設定ファイルを確認
```bash
cat ~/.config/backup-suite/config.toml
```

3. 設定ファイルの権限を確認
```bash
ls -la ~/.config/backup-suite/config.toml
# rw-r--r-- であることを確認
```

### Q5. メモリ使用量が多い

**症状**: Smart機能実行時にメモリ使用量が100MB以上

**原因**: 大量のファイルをキャッシュしている

**解決策**:
1. キャッシュをクリア（プロセス再起動）
2. より小さいディレクトリ単位で分析
3. `--no-cache` オプション（実装予定）

---

## 今後の拡張予定

### Phase 2: Ollama統合（計画中）

**オプション機能** - Phase 1（軽量ML）は常に利用可能

- 自然言語バックアップ設定
- AI駆動レポート生成
- インタラクティブアシスタント
- バックアップ統計の自然言語サマリー

**Graceful Degradation**:
- Ollama未インストール時は Phase 1 機能のみ提供
- インストールガイド表示
- 代替機能の案内

詳細は [AI実装計画書](./AI_IMPLEMENTATION_PLAN.md) を参照してください。

---

## 参考資料

- [AI実装計画書](./AI_IMPLEMENTATION_PLAN.md): 詳細な実装仕様
- [AI推奨エンジン実装報告](./AI_RECOMMENDATION_ENGINE.md): 推奨エンジンの詳細
- [AIテストレポート](./AI_TEST_REPORT.md): テストカバレッジとベンチマーク
- [ソースコード](../src/smart/): Smart機能の実装

---

**最終更新**: 2025-11-09
**バージョン**: 1.0.0 (Phase 1完成)
